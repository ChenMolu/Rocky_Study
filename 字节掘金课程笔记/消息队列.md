# 掘金课程 消息队列(中间件)

### 四个案例以及解决方案

案例一：系统奔溃

![image-20230213103524336](.\消息队列.assets\image-20230213103524336.png)

如果此时记录存储程序所在的机房被删库跑路了，上面这个流程会发生什么问题？

![image-20230213103040119](.\消息队列.assets\image-20230213103040119.png)

案例二：服务处理能力有限

![image-20230213103713723](.\消息队列.assets\image-20230213103713723.png)



![image-20230213103114917](.\消息队列.assets\image-20230213103114917.png)

案例三：链路耗时时间长

提交订单之后一直再进行处理。

![image-20230213103804391](.\消息队列.assets\image-20230213103804391.png)

将这部分进行异步处理

![image-20230213103254230](.\消息队列.assets\image-20230213103254230.png)

案例四：日志如何处理

![image-20230213103345596](.\消息队列.assets\image-20230213103345596.png)

## 一、 消息队列的前世今生

![image-20230213103939353](.\消息队列.assets\image-20230213103939353.png)

常见的消息队列：

![image-20230213104240786](.\消息队列.assets\image-20230213104240786.png)

## 二、消息队列Kafka

2.1 使用场景：

搜索服务、直播服务、订单服务、支付服务

![image-20230213104446112](.\消息队列.assets\image-20230213104446112.png)

2.2 如何使用kafka

创建集群->新增Topic->编写生产者逻辑->编写消费者逻辑

2.3 基本概念

![image-20230213104646208](消息队列.assets\image-20230213104646208.png)

Offset：

![image-20230213105144077](消息队列.assets/image-20230213105144077.png)

Replica：

副本，完成容灾

Follower努力与Leader保持一致

差距过大会被从ISR中删除

![image-20230213105326445](消息队列.assets/image-20230213105326445.png)

2.4 数据复制

![image-20230213105557317](消息队列.assets/image-20230213105557317.png)

2.5 Kafka架构

![image-20230213105721576](消息队列.assets/image-20230213105721576.png)

2.6 一条消息的自述

![image-20230213105750024](消息队列.assets/image-20230213105750024.png)

![image-20230213105809411](消息队列.assets/image-20230213105809411.png)

如果发送一条消息，等到其成功之后再发一条会有什么问题？ 消息处理速度太慢

2.7 Producer：可以选择进行批量处理

![image-20230213110103833](消息队列.assets/image-20230213110103833.png)

新问题 - 消息量很大的时候，网络带宽不够用

Producer Kafka支持数据压缩，通过压缩可以较少消息大小

![image-20230213110148349](消息队列.assets/image-20230213110148349.png)

2.8 Broker 数据存储

![image-20230213110329906](消息队列.assets/image-20230213110329906.png)

![image-20230213110342802](消息队列.assets/image-20230213110342802.png)

数据路径：/Topic/Partition/Segment/(log | index | timeindex | ......)

Broker 顺序写

Broker  如何找到消息

![image-20230213111240967](消息队列.assets/image-20230213111240967.png)

 二分法寻找磁盘中的数据

Broker 传统数据拷贝

![image-20230213134513152](消息队列.assets/image-20230213134513152.png)

Broker 零拷贝

![image-20230213134545816](消息队列.assets/image-20230213134545816.png)